name: Deploy Battery to Github Pages
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  battery-deploy:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout Repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0  # Fetch all history for all branches and tags
            persist-credentials: true

        - name: Install Node.js
          uses: actions/setup-node@v3
          with:
            node-version: '20'

        - name: Install Dependencies
          run: |
            npm ci --prefix ./anendophasia-questionnaire
            npm ci --prefix ./anendophasia-task-switching
            npm ci --prefix ./rhyme-judgments

        - name: Build Battery
          run: |
            npm run build --prefix ./anendophasia-questionnaire
            npm run build --prefix ./anendophasia-task-switching
            npm run build --prefix ./rhyme-judgments
        
        - name: Prepare public directory
          run: |
            rm -rf public
            mkdir -p public
            cp index.html public/index.html
            mkdir -p public/anendophasia-questionnaire/dist public/rhyme-judgments/dist public/anendophasia-task-switching/dist public/anendophasia-full-battery/dist
            cp -a anendophasia-questionnaire/dist/. public/anendophasia-questionnaire/dist/ || true
            cp -a rhyme-judgments/dist/. public/rhyme-judgments/dist/ || true
            cp -a anendophasia-task-switching/dist/. public/anendophasia-task-switching/dist/ || true
            cp -a anendophasia-full-battery/dist/. public/anendophasia-full-battery/dist/ || true
            touch public/.nojekyll
        
        - name: Deploy to gh-pages
          uses: peaceiris/actions-gh-pages@v3
          with:
            publish_dir: ./public
            publish_branch: gh-pages
            github_token: ${{ secrets.GITHUB_TOKEN }}